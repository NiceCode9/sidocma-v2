{{-- <script type="module">
    // Notification Bell JavaScript - Letakkan di app.blade.php atau layout utama

    class NotificationBell {
        constructor() {
            this.countElement = document.getElementById('notification-count');
            this.listElement = document.getElementById('notification-list');
            this.noNotificationsElement = document.getElementById('no-notifications');
            this.markAllReadBtn = document.getElementById('mark-all-read');

            this.init();
        }

        init() {
            // Load initial notifications
            this.loadUnreadCount();
            this.loadNotifications();

            // Setup event listeners
            this.setupEventListeners();

            // Setup Laravel Echo listeners
            this.setupEchoListeners();
        }

        setupEventListeners() {
            // Mark all as read
            this.markAllReadBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                this.markAllAsRead();
            });

            // Dropdown toggle - load notifications when opened
            document.getElementById('notification-bell')?.addEventListener('click', () => {
                this.loadNotifications();
            });
        }

        setupEchoListeners() {
            @auth
            // Listen to private channel for current user
            window.Echo.private(`suratmasuk.{{ auth()->user()->id }}`)
                .listen('.surat-masuk', (e) => {
                    console.log('New notification received:', e);
                    this.handleNewNotification(e);
                });

            // Optional: Listen to public channel
            window.Echo.channel('suratmasuk')
                .listen('.surat-masuk', (e) => {
                    console.log('Public notification:', e);
                    this.handleNewNotification(e);
                });
        @endauth
    }

    handleNewNotification(data) {
        // Update count
        this.updateNotificationCount(1);

        // Show browser notification
        this.showBrowserNotification('Surat Baru', data.message || 'Anda memiliki surat masuk baru');

        // Reload notifications list
        this.loadNotifications();

        // Add animation to bell
        this.animateBell();
    }

    async loadUnreadCount() {
        try {
            const response = await fetch('/notifications/unread-count');
            const data = await response.json();

            if (data.success) {
                this.setNotificationCount(data.unread_count);
            }
        } catch (error) {
            console.error('Error loading unread count:', error);
        }
    }

    async loadNotifications() {
        try {
            const response = await fetch('/notifications/list');
            const data = await response.json();

            if (data.success) {
                this.renderNotifications(data.notifications);
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    renderNotifications(notifications) {
        if (!this.listElement) return;

        if (notifications.length === 0) {
            this.listElement.innerHTML =
                '<div class="text-center py-3"><small class="text-muted">No notifications</small></div>';
            return;
        }

        const notificationHtml = notifications.map(notification => `
            <div class="notification-item ${!notification.is_read ? 'unread' : ''}"
                 onclick="notificationBell.handleNotificationClick(${notification.id}, '${notification.url}')">
                <div class="d-flex">
                    <div class="notification-icon bg-primary text-white">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-meta">
                            <small class="text-muted">From: ${notification.sender}</small>
                            <span class="mx-1">â€¢</span>
                            <small class="text-muted">${notification.time_ago}</small>
                        </div>
                    </div>
                    ${!notification.is_read ? '<div class="notification-dot bg-primary"></div>' : ''}
                </div>
            </div>
        `).join('');

        this.listElement.innerHTML = notificationHtml;
    }

    async handleNotificationClick(notificationId, url) {
        try {
            // Mark as read
            await this.markAsRead(notificationId);

            // Navigate to URL if provided
            if (url && url !== '#') {
                window.location.href = url;
            }
        } catch (error) {
            console.error('Error handling notification click:', error);
        }
    }

    async markAsRead(notificationId) {
        try {
            const response = await fetch(`/notifications/${notificationId}/mark-read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute(
                        'content')
                }
            });

            const data = await response.json();

            if (data.success) {
                this.updateNotificationCount(-1);
                this.loadNotifications(); // Refresh list
            }
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }

    async markAllAsRead() {
        try {
            const response = await fetch('/notifications/mark-all-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute(
                        'content')
                }
            });

            const data = await response.json();

            if (data.success) {
                this.setNotificationCount(0);
                this.loadNotifications(); // Refresh list

                // Show success message
                if (typeof toastr !== 'undefined') {
                    toastr.success('All notifications marked as read');
                }
            }
        } catch (error) {
            console.error('Error marking all notifications as read:', error);
        }
    }

    setNotificationCount(count) {
        if (!this.countElement) return;

        if (count > 0) {
            this.countElement.textContent = count > 99 ? '99+' : count;
            this.countElement.style.display = 'block';
        } else {
            this.countElement.style.display = 'none';
        }
    }

    updateNotificationCount(increment) {
        const currentCount = parseInt(this.countElement.textContent) || 0;
        const newCount = Math.max(0, currentCount + increment);
        this.setNotificationCount(newCount);
    }

    showBrowserNotification(title, message) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body: message,
                icon: '/favicon.ico', // Ganti dengan path icon Anda
                tag: 'surat-notification'
            });
        }
    }

    animateBell() {
        const bellElement = document.getElementById('notification-bell');
        if (bellElement) {
            bellElement.classList.add('animate__animated', 'animate__swing');
            setTimeout(() => {
                bellElement.classList.remove('animate__animated', 'animate__swing');
            }, 1000);
        }
    }
    }

    // Initialize notification bell when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Initialize notification bell
        window.notificationBell = new NotificationBell();
    });

    const notificationStyles = document.createElement('style');
    notificationStyles.textContent = `
            .notification-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                margin-top: 5px;
            }

            .notification-meta {
                font-size: 0.8em;
                color: #666;
                margin-top: 2px;
            }

            @keyframes swing {
                20% { transform: rotate3d(0, 0, 1, 15deg); }
                40% { transform: rotate3d(0, 0, 1, -10deg); }
                60% { transform: rotate3d(0, 0, 1, 5deg); }
                80% { transform: rotate3d(0, 0, 1, -5deg); }
                100% { transform: rotate3d(0, 0, 1, 0deg); }
            }

            .animate__swing {
                animation: swing 1s ease-in-out;
            }
        `;
    document.head.appendChild(notificationStyles);
</script> --}}

{{-- <script type="module">
    // Pastikan user sudah login dan memiliki ID
    @auth
    // Listen ke private channel untuk user yang login
    window.Echo.private(`suratmasuk.{{ auth()->user()->id }}`)
        .listen('.surat-masuk', (e) => {
            console.log('Surat baru diterima:', e);

            // Tampilkan notifikasi atau update UI
            showNotification('Surat Baru', e.message);

            // Update counter atau refresh data jika diperlukan
            updateSuratCounter();
        });
    @endauth

    // Fungsi untuk menampilkan notifikasi
    function showNotification(title, message) {
        // Gunakan library notifikasi seperti toastr, SweetAlert, atau browser notification
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body: message,
                icon: '/path-to-your-icon.png'
            });
        } else {
            // Fallback ke alert atau custom notification
            alert(`${title}: ${message}`);
        }
    }

    // Fungsi untuk update counter surat
    function updateSuratCounter() {
        // Fetch data terbaru dari server atau update counter di UI
        fetch('/notifications/unread-count')
            .then(response => response.json())
            .then(data => {
                // Update badge counter di navbar atau sidebar
                const badge = document.querySelector('#surat-counter');
                if (badge) {
                    badge.textContent = data.count;
                }
            });
    }

    // Request permission untuk browser notifications
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    Notification.requestPermission();
</script> --}}

{{-- v2 --}}

<script type="module">
    // Updated Notification Bell JavaScript with Better Styling
    class SuratNotificationBell {
        constructor() {
            this.countElement = document.getElementById('notification-count');
            this.listElement = document.getElementById('notification-list');
            this.markAllReadBtn = document.getElementById('mark-all-read');
            this.bellElement = document.getElementById('notification-bell');
            this.loadingElement = document.getElementById('loading-notifications');

            this.init();
        }

        init() {
            // Load initial data
            this.loadUnreadCount();

            // Setup event listeners
            this.setupEventListeners();

            // Setup Laravel Echo listeners for real-time notifications
            this.setupEchoListeners();
        }

        setupEventListeners() {
            // Mark all as read
            this.markAllReadBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                this.markAllAsRead();
            });

            // Load notifications when dropdown is opened
            this.bellElement?.addEventListener('click', () => {
                this.loadNotifications();
            });
        }

        setupEchoListeners() {
            @auth
            // Listen to private channel for current user
            window.Echo.private(`suratmasuk.{{ auth()->user()->id }}`)
                .listen('.surat-masuk', (e) => {
                    console.log('New surat notification:', e);
                    this.handleNewNotification(e);
                });
        @endauth
    }

    handleNewNotification(data) {
        // Update count immediately
        this.updateNotificationCount(1);

        // Show browser notification
        this.showBrowserNotification('Surat Masuk Baru', data.message || 'Anda memiliki surat masuk baru');

        // Add bell animation
        this.animateBell();

        // Show toast notification if available
        if (typeof toastr !== 'undefined') {
            toastr.info('Surat masuk baru diterima!', 'Notifikasi');
        }
    }

    async loadUnreadCount() {
        try {
            const response = await fetch('/notifications/unread-count');
            const data = await response.json();

            if (data.success) {
                this.setNotificationCount(data.unread_count);
            }
        } catch (error) {
            console.error('Error loading unread count:', error);
        }
    }

    async loadNotifications() {
        if (!this.listElement) return;

        // Show loading
        this.showLoading(true);

        try {
            const response = await fetch('/notifications/list?limit=10');
            const data = await response.json();

            if (data.success) {
                this.renderNotifications(data.notifications);
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
            this.listElement.innerHTML = `
                <div class="text-center py-3 text-danger">
                    <i class="fas fa-exclamation-triangle mb-2"></i>
                    <p class="mb-0">Error loading notifications</p>
                </div>
            `;
        } finally {
            this.showLoading(false);
        }
    }

    renderNotifications(notifications) {
        if (!this.listElement) return;

        if (notifications.length === 0) {
            this.listElement.innerHTML = `
                <div class="notification-empty">
                    <i class="fas fa-bell-slash text-muted"></i>
                    <p class="mb-0">Tidak ada surat masuk</p>
                </div>
            `;
            return;
        }

        const notificationHtml = notifications.map(notification => `
            <a href="#" class="dropdown-item ${!notification.is_read ? 'notification-item-unread' : ''}"
               onclick="suratNotificationBell.handleNotificationClick(${notification.id}, event)">
                <div class="dropdown-item-icon bg-primary text-white">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="dropdown-item-desc">
                    <div class="font-weight-bold">${notification.message}</div>
                    <div class="text-small text-muted mt-1">
                        <span class="badge badge-light mr-1">${notification.no_surat}</span>
                        Dari: ${notification.sender}
                    </div>
                    <div class="time ${!notification.is_read ? 'text-primary font-weight-bold' : 'text-muted'} mt-1">
                        <i class="far fa-clock mr-1"></i>${notification.time_ago}
                    </div>
                </div>
                ${!notification.is_read ? '<div class="dropdown-item-indicator bg-primary"></div>' : ''}
            </a>
        `).join('');

        this.listElement.innerHTML = notificationHtml;
    }

    async handleNotificationClick(notificationId, event) {
        event.preventDefault();

        try {
            await this.markAsRead(notificationId);

            // Optional: redirect to surat detail or management page
            // window.location.href = '/surat/manage';
        } catch (error) {
            console.error('Error handling notification click:', error);
        }
    }

    async markAsRead(notificationId) {
        try {
            const response = await fetch(`/notifications/${notificationId}/mark-read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute(
                        'content')
                }
            });

            const data = await response.json();

            if (data.success) {
                this.updateNotificationCount(-1);
                // Refresh notifications list after short delay
                setTimeout(() => this.loadNotifications(), 300);
            }
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }

    async markAllAsRead() {
        try {
            // Show loading state
            this.markAllReadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            this.markAllReadBtn.style.pointerEvents = 'none';

            const response = await fetch('/notifications/mark-all-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute(
                        'content')
                }
            });

            const data = await response.json();

            if (data.success) {
                this.setNotificationCount(0);
                this.loadNotifications();

                if (typeof toastr !== 'undefined') {
                    toastr.success('Semua notifikasi telah dibaca');
                }
            }
        } catch (error) {
            console.error('Error marking all notifications as read:', error);
            if (typeof toastr !== 'undefined') {
                toastr.error('Error marking notifications as read');
            }
        } finally {
            // Reset button state
            this.markAllReadBtn.innerHTML = 'Mark All As Read';
            this.markAllReadBtn.style.pointerEvents = 'auto';
        }
    }

    setNotificationCount(count) {
        if (!this.countElement) return;

        if (count > 0) {
            this.countElement.textContent = count > 99 ? '99+' : count;
            this.countElement.style.display = 'flex';
            this.countElement.classList.remove('hidden');

            // Remove beep class if exists and add our custom badge
            this.bellElement?.classList.remove('beep');
        } else {
            this.countElement.style.display = 'none';
            this.countElement.classList.add('hidden');

            // Remove beep class
            this.bellElement?.classList.remove('beep');
        }
    }

    updateNotificationCount(increment) {
        const currentCount = parseInt(this.countElement?.textContent) || 0;
        const newCount = Math.max(0, currentCount + increment);
        this.setNotificationCount(newCount);
    }

    showBrowserNotification(title, message) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body: message,
                icon: '/img/avatar/avatar-1.png', // Sesuaikan dengan path icon Anda
                tag: 'surat-notification',
                requireInteraction: false
            });
        }
    }

    animateBell() {
        if (this.bellElement) {
            // Remove existing animation class
            this.bellElement.classList.remove('bell-shake');

            // Add animation class
            this.bellElement.classList.add('bell-shake');

            // Remove animation class after animation completes
            setTimeout(() => {
                this.bellElement.classList.remove('bell-shake');
            }, 500);
        }
    }

    showLoading(show) {
        if (this.loadingElement) {
            this.loadingElement.style.display = show ? 'block' : 'none';
        }

        if (show && this.listElement) {
            this.listElement.innerHTML = `
                <div class="notification-loading">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mb-0 mt-2 text-muted">Memuat notifikasi...</p>
                </div>
            `;
        }
    }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Initialize notification bell
        window.suratNotificationBell = new SuratNotificationBell();
    });

    // Add additional CSS for dropdown item indicator
    const additionalStyle = document.createElement('style');
    additionalStyle.textContent = `
    .dropdown-item-indicator {
        position: absolute;
        top: 50%;
        right: 10px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        transform: translateY(-50%);
    }

    .dropdown-item {
        position: relative;
        padding-right: 30px;
    }
`;
    document.head.appendChild(additionalStyle);
</script>
